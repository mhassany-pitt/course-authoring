<div class="flex flex-col">
  <div class="px-10 py-4 bg-gray-100 shadow-md fixed left-0 top-0 right-0 z-10">
    <div
      class="container mx-auto flex items-center gap-2 px-2 md:px-0 max-w-7xl"
    >
      <img src="assets/logo.png" class="h-8 w-8" />
      <span class="text-xl font-bold hidden md:inline-block text-nowrap">
        Course Authoring
      </span>
      <span class="hidden md:inline-block">
        <i class="pi pi-chevron-right"></i>
      </span>

      <p-dropdown
        #navEl
        [options]="navLinks"
        [ngModel]="'/catalog-v2'"
        class="-my-2 course-nav-dropdown"
        (onChange)="router.navigate([$event.value])"
      ></p-dropdown>

      <span class="flex-grow"></span>

      <app-user-auth-ctrl logoutRedirect="/hub"></app-user-auth-ctrl>
    </div>
  </div>

  <div
    class="container mx-auto mt-24 mb-16 flex flex-col gap-4 max-w-7xl z-0 relative"
  >
    <!-- header -->
    <h1 class="my-0">
      <span class="text-3xl font-bold"> SLCs Catalog </span>
      <span class="text-gray-500 text-sm ml-2">
        ({{ items?.length || 0 }} Smart Learning Components)
      </span>
    </h1>

    <a
      href="https://docs.google.com/document/d/1URcBdMdkGWGlx7Z5cXrb9T_Oiqkfn1BEV7P3CBLleJo/edit?usp=sharing"
      target="_blank"
      class="absolute top-2 right-2"
    >
      <p-button type="button" label="Documentation" icon="fa fa-book" />
    </a>

    <p class="text-gray-400 text-xs -mt-2">
      Use the search box below to filter SLCs by ID, title, type, status,
      author, prompt, or tags. <br />
      Click on an SLC title to view more details. or click the
      <i class="fa fa-external-link"></i> to view the demo page.
    </p>

    <div class="flex items-start gap-6">
      <!-- sidebar -->
      <div
        class="w-1/3 bg-slate-100 border border-slate-200 rounded-lg p-3 shadow-sm flex flex-col items-start gap-3"
      >
        <div class="w-full flex items-center gap-2 justify-end">
          <span *ngIf="table.filteredValue" class="grow">
            {{ table.filteredValue.length }} matched.
          </span>
          <a
            *ngIf="selectedKVs['count'] > 0"
            class="flex items-center gap-1 text-red-700 cursor-pointer border border-solid border-red-400 px-2 py-1 rounded hover:bg-red-100 active:bg-red-200"
            (click)="clearQuickFilters(table)"
          >
            <span class="">Clear Filters</span>
            <i class="pi pi-times"></i>
          </a>
        </div>

        <div class="text-gray-500 text-xs uppercase">
          Quick Filters (click to toggle)
        </div>

        <div class="w-full flex flex-wrap gap-1 pl-2">
          <div class="flex items-center gap-2 w-full -ml-2">
            <span class="text-sm font-bold text-gray-600">Types: </span>
            <hr class="grow" />
          </div>
          <a
            *ngFor="let facet of typeKVs"
            class="text-xs cursor-pointer hover:underline"
            [class.font-bold]="
              selectedKVs['identity.type']?.label == facet.label
            "
            [class.text-blue-700]="
              selectedKVs['identity.type']?.label == facet.label
            "
            [class.underline]="
              selectedKVs['identity.type']?.label == facet.label
            "
            (click)="toggleQuickFilter(table, 'identity.type', facet, 'equals')"
          >
            {{ facet.label }} ({{ facet.value }}),
          </a>
          <span class="text-sm text-gray-400" *ngIf="!typeKVs.length">
            No types yet.
          </span>
        </div>

        <div class="w-full flex flex-wrap gap-1 pl-2">
          <div class="flex items-center gap-2 w-full -ml-2">
            <span class="text-sm font-bold text-gray-600"
              >Programming Languages:</span
            >
            <hr class="grow" />
          </div>
          <a
            *ngFor="let facet of plKVs"
            class="text-xs cursor-pointer hover:underline"
            [class.font-bold]="
              selectedKVs['languages.programming_languages']?.label ==
              facet.label
            "
            [class.text-blue-700]="
              selectedKVs['languages.programming_languages']?.label ==
              facet.label
            "
            [class.underline]="
              selectedKVs['languages.programming_languages']?.label ==
              facet.label
            "
            (click)="
              toggleQuickFilter(
                table,
                'languages.programming_languages',
                facet,
                'equals'
              )
            "
          >
            {{ facet.label }} ({{ facet.value }}),
          </a>
          <span class="text-sm text-gray-400" *ngIf="!plKVs.length">
            No programming languages yet.
          </span>
        </div>

        <div class="w-full flex flex-wrap gap-1 pl-2">
          <div class="flex items-center gap-2 w-full -ml-2">
            <span class="text-sm font-bold text-gray-600">Authors:</span>
            <hr class="grow" />
          </div>
          <a
            *ngFor="let facet of authorKVs"
            class="text-xs cursor-pointer hover:underline"
            [class.font-bold]="
              selectedKVs['attribution._authors']?.label == facet.label
            "
            [class.text-blue-700]="
              selectedKVs['attribution._authors']?.label == facet.label
            "
            [class.underline]="
              selectedKVs['attribution._authors']?.label == facet.label
            "
            (click)="
              toggleQuickFilter(
                table,
                'attribution._authors',
                facet,
                'contains'
              )
            "
          >
            {{ facet.label }} ({{ facet.value }}),
          </a>
          <span class="text-sm text-gray-400" *ngIf="!authorKVs.length">
            No authors yet.
          </span>
        </div>

        <div class="w-full flex flex-wrap gap-1 pl-2">
          <div class="flex items-center gap-2 w-full -ml-2">
            <span class="text-sm font-bold text-gray-600">Providers:</span>
            <hr class="grow" />
          </div>
          <a
            *ngFor="let facet of providersKVs"
            class="text-xs cursor-pointer hover:underline"
            [class.font-bold]="
              selectedKVs['attribution.provider']?.label == facet.label
            "
            [class.text-blue-700]="
              selectedKVs['attribution.provider']?.label == facet.label
            "
            [class.underline]="
              selectedKVs['attribution.provider']?.label == facet.label
            "
            (click)="
              toggleQuickFilter(table, 'attribution.provider', facet, 'equals')
            "
          >
            {{ facet.label }} ({{ facet.value }}),
          </a>
          <span class="text-sm text-gray-400" *ngIf="!providersKVs.length">
            No providers yet.
          </span>
        </div>

        <div class="w-full flex flex-wrap gap-1 pl-2">
          <div class="flex items-center gap-2 w-full -ml-2">
            <span class="text-sm font-bold text-gray-600">Licenses:</span>
            <hr class="grow" />
          </div>
          <a
            *ngFor="let facet of licenseKVs"
            class="text-xs cursor-pointer hover:underline"
            [class.font-bold]="
              selectedKVs['rights.license']?.label == facet.label
            "
            [class.text-blue-700]="
              selectedKVs['rights.license']?.label == facet.label
            "
            [class.underline]="
              selectedKVs['rights.license']?.label == facet.label
            "
            (click)="
              toggleQuickFilter(table, 'rights.license', facet, 'equals')
            "
          >
            {{ facet.label }} ({{ facet.value }}),
          </a>
          <span class="text-sm text-gray-400" *ngIf="!licenseKVs.length">
            No licenses yet.
          </span>
        </div>

        <div class="w-full flex flex-wrap gap-1 pl-2">
          <div class="flex items-center gap-2 w-full -ml-2">
            <span class="text-sm font-bold text-gray-600">Tags:</span>
            <hr class="grow" />
          </div>
          <a
            *ngFor="let facet of tagKVs"
            class="text-xs cursor-pointer hover:underline"
            [class.font-bold]="selectedKVs['tags']?.label == facet.label"
            [class.text-blue-700]="selectedKVs['tags']?.label == facet.label"
            [class.underline]="selectedKVs['tags']?.label == facet.label"
            (click)="toggleQuickFilter(table, 'tags', facet, 'contains')"
          >
            {{ facet.label }} ({{ facet.value }}),
          </a>
          <span class="text-sm text-gray-400" *ngIf="!tagKVs.length">
            No tags yet.
          </span>
        </div>
      </div>

      <!-- search & table -->
      <div class="w-2/3 flex flex-col gap-4">
        <div class="bg-gray-100 shadow-md">
          <input
            #searchInputEl
            type="text"
            name="name"
            pInputText
            placeholder="Search ..."
            class="text-xl border-gray-200 w-full"
            (keyup)="filter(table, $event)"
          />
        </div>

        <p-table
          #table
          [value]="items"
          [globalFilterFields]="[
            'id',
            'identity.title',
            'identity.id',
            'identity.type',
            'status',
            'content.prompt',
            'attribution._authors',
            'tags',
          ]"
          class="border shadow-md"
          (onFilter)="reloadFilterKVs(table.filteredValue || items)"
        >
          <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
            <tr>
              <td>
                <div class="flex flex-col gap-1">
                  <span class="text-xs uppercase text-gray-400">
                    {{ item.identity?.type }} |
                    {{ item.listed_at | date: "medium" }}
                  </span>
                  <div class="flex items-center gap-2">
                    <a
                      [routerLink]="['/catalog-v2', item.id]"
                      class="font-bold cursor-pointer text-blue-700"
                    >
                      {{ item.identity?.title || "Untitled" }}
                    </a>
                    <span
                      class="text-xs rounded-md px-1"
                      [class.bg-slate-200]="item.status == 'private'"
                      [class.bg-green-200]="item.status == 'public'"
                      [class.bg-red-200]="item.status == 'deprecated'"
                      [class.bg-yellow-200]="item.status == 'broken:pending-fix'"
                    >
                      {{ item.status }}
                    </span>
                    <a
                      *ngIf="item.links?.demo_url"
                      [href]="item.links.demo_url"
                      target="_blank"
                      class="text-gray-400"
                      title="View Demo"
                    >
                      <i class="fa fa-external-link"></i>
                    </a>
                  </div>
                  <span class="ml-2 text-xs">
                    ID: {{ item.identity?.id }}
                  </span>
                  <span class="ml-2 text-xs">
                    Author(s):
                    {{ item.attribution._authors || "Unknown Author" }}
                  </span>
                  <span *ngIf="item.content?.prompt" class="ml-2 text-xs">
                    Prompt: {{ item.content.prompt }}
                  </span>
                  <span *ngIf="item.tags?.length" class="ml-2 text-xs">
                    Tags: {{ item.tags.join(", ") }}
                  </span>
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td>
                <div class="text-xs text-center text-gray-400 w-full">
                  no record matched, revise your filter keyword
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</div>
