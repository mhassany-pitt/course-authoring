<div class="flex flex-col">
  <div class="px-10 py-4 bg-gray-100 shadow-md fixed left-0 top-0 right-0 z-10">
    <div
      class="container mx-auto flex items-center gap-2 px-2 md:px-0 max-w-7xl"
    >
      <img src="assets/logo.png" class="h-8 w-8" />
      <span class="text-xl font-bold hidden md:inline-block text-nowrap">
        Course Authoring
      </span>
      <span class="hidden md:inline-block">
        <i class="pi pi-chevron-right"></i>
      </span>

      <p-dropdown
        #navEl
        [options]="navLinks"
        [ngModel]="'/catalog-v2'"
        class="-my-2 course-nav-dropdown"
        (onChange)="router.navigate([$event.value])"
      ></p-dropdown>

      <span class="flex-grow"></span>

      <app-user-auth-ctrl logoutRedirect="/hub"></app-user-auth-ctrl>
    </div>
  </div>

  <div
    class="container mx-auto mt-24 mb-16 flex flex-col gap-4 max-w-7xl z-0 relative"
  >
    <!-- header -->
    <h1 class="my-0">
      <span class="text-3xl font-bold"> SLCs Catalog </span>
      <span class="text-gray-500 text-sm ml-2">
        ({{ items?.length || 0 }} Smart Learning Contents)
      </span>
    </h1>

    <a
      href="https://docs.google.com/document/d/1URcBdMdkGWGlx7Z5cXrb9T_Oiqkfn1BEV7P3CBLleJo/edit?usp=sharing"
      target="_blank"
      class="absolute top-2 right-2"
    >
      <p-button type="button" label="Documentation" icon="fa fa-book" />
    </a>

    <p class="text-gray-400 text-xs -mt-2">
      Use the search box below to filter SLCs by ID, title, type, status,
      author, prompt, or tags. <br />
      Click on an SLC title to view more details. or click the
      <i class="fa fa-external-link"></i> to view the demo page.
    </p>

    <div class="flex flex-col gap-4">
      <div class="w-full flex flex-col gap-0">
        <div
          class="bg-gray-100 shadow-md relative border border-slate-200"
          [class.rounded-t-lg]="quickFiltersExpanded"
          [class.rounded-lg]="!quickFiltersExpanded"
        >
          <input
            type="text"
            name="name"
            pInputText
            placeholder="Search ..."
            class="text-xl border-gray-200 w-full pr-12"
            [(ngModel)]="globalQuery"
            (keyup)="filter(table, $event, true)"
            (blur)="filter(table, $event)"
          />
          <div
            class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center justify-center gap-2"
          >
            <p-button
              type="button"
              (click)="toggleQuickFiltersPanel()"
              label="Quick Filters"
              aria-label="Quick Filters"
              icon="fa fa-filter"
              iconPos="right"
              [severity]="quickFiltersExpanded ? 'contrast' : 'secondary'"
              [outlined]="!quickFiltersExpanded"
              [attr.aria-pressed]="quickFiltersExpanded"
            />
          </div>
        </div>

        <div
          *ngIf="selectedKVs['count'] > 0 || quickFiltersExpanded"
          class="border-l border-r border-b border-t-0 border-solid border-gray-200 p-4 rounded-b-md shadow-md bg-white relative overflow-auto flex flex-col items-start gap-2"
        >
          <div
            *ngIf="activeQuickFilters.length"
            class="w-full flex flex-wrap items-center gap-1 text-xs text-gray-500"
          >
            <span class="uppercase">Active Filters:</span>

            <a
              *ngFor="let filter of activeQuickFilters; let $index = index"
              class="text-xs cursor-pointer hover:underline font-bold text-blue-700 underline"
              (click)="
                toggleActiveQuickFilter(table, filter.field, filter.label)
              "
              aria-label="Toggle quick filter"
            >
              {{
                $index < activeQuickFilters.length - 1
                  ? filter.label + ","
                  : filter.label
              }}
            </a>

            <span class="grow"></span>
            <p-button
              *ngIf="table && table.filteredValue"
              [label]="table.filteredValue.length + ' Matched'"
              icon="fa fa-times"
              iconPos="right"
              severity="danger"
              outlined="true"
              styleClass="px-2 py-1 text-xs items-center"
              (click)="clearQuickFilters(table)"
            >
            </p-button>
          </div>

          <ng-container *ngIf="quickFiltersExpanded">
            <div class="text-gray-400 text-xs uppercase">Click to toggle</div>

            <div class="w-full flex flex-wrap gap-1 pl-2">
              <div class="flex items-center gap-2 w-full -ml-2">
                <span class="text-sm font-bold text-gray-600">Types: </span>
                <hr class="grow" />
              </div>
              <a
                *ngFor="let facet of typeKVs"
                class="text-xs cursor-pointer hover:underline"
                [class.font-bold]="
                  isQuickFilterSelected('identity.type', facet.label)
                "
                [class.text-blue-700]="
                  isQuickFilterSelected('identity.type', facet.label)
                "
                [class.underline]="
                  isQuickFilterSelected('identity.type', facet.label)
                "
                [class.text-gray-400]="
                  !isQuickFilterSelected('identity.type', facet.label) &&
                  !isQuickFilterAvailable('identity.type', facet.label)
                "
                (click)="toggleQuickFilter(table, 'identity.type', facet)"
              >
                {{ facet.label }} ({{ facet.value }}),
              </a>
              <span class="text-sm text-gray-400" *ngIf="!typeKVs.length">
                No types yet.
              </span>
            </div>

            <div class="w-full flex flex-wrap gap-1 pl-2">
              <div class="flex items-center gap-2 w-full -ml-2">
                <span class="text-sm font-bold text-gray-600"
                  >Programming Languages:</span
                >
                <hr class="grow" />
              </div>
              <a
                *ngFor="let facet of plKVs"
                class="text-xs cursor-pointer hover:underline"
                [class.font-bold]="
                  isQuickFilterSelected(
                    'languages.programming_languages',
                    facet.label
                  )
                "
                [class.text-blue-700]="
                  isQuickFilterSelected(
                    'languages.programming_languages',
                    facet.label
                  )
                "
                [class.underline]="
                  isQuickFilterSelected(
                    'languages.programming_languages',
                    facet.label
                  )
                "
                [class.text-gray-400]="
                  !isQuickFilterSelected(
                    'languages.programming_languages',
                    facet.label
                  ) &&
                  !isQuickFilterAvailable(
                    'languages.programming_languages',
                    facet.label
                  )
                "
                (click)="
                  toggleQuickFilter(
                    table,
                    'languages.programming_languages',
                    facet
                  )
                "
              >
                {{ facet.label }} ({{ facet.value }}),
              </a>
              <span class="text-sm text-gray-400" *ngIf="!plKVs.length">
                No programming languages yet.
              </span>
            </div>

            <div class="w-full flex flex-wrap gap-1 pl-2">
              <div class="flex items-center gap-2 w-full -ml-2">
                <span class="text-sm font-bold text-gray-600">Authors:</span>
                <hr class="grow" />
              </div>
              <a
                *ngFor="let facet of authorKVs"
                class="text-xs cursor-pointer hover:underline"
                [class.font-bold]="
                  isQuickFilterSelected('attribution.authors', facet.label)
                "
                [class.text-blue-700]="
                  isQuickFilterSelected('attribution.authors', facet.label)
                "
                [class.underline]="
                  isQuickFilterSelected('attribution.authors', facet.label)
                "
                [class.text-gray-400]="
                  !isQuickFilterSelected('attribution.authors', facet.label) &&
                  !isQuickFilterAvailable('attribution.authors', facet.label)
                "
                (click)="toggleQuickFilter(table, 'attribution.authors', facet)"
              >
                {{ facet.label }} ({{ facet.value }}),
              </a>
              <span class="text-sm text-gray-400" *ngIf="!authorKVs.length">
                No authors yet.
              </span>
            </div>

            <div class="w-full flex flex-wrap gap-1 pl-2">
              <div class="flex items-center gap-2 w-full -ml-2">
                <span class="text-sm font-bold text-gray-600">Providers:</span>
                <hr class="grow" />
              </div>
              <a
                *ngFor="let facet of providersKVs"
                class="text-xs cursor-pointer hover:underline"
                [class.font-bold]="
                  isQuickFilterSelected('attribution.provider', facet.label)
                "
                [class.text-blue-700]="
                  isQuickFilterSelected('attribution.provider', facet.label)
                "
                [class.underline]="
                  isQuickFilterSelected('attribution.provider', facet.label)
                "
                [class.text-gray-400]="
                  !isQuickFilterSelected('attribution.provider', facet.label) &&
                  !isQuickFilterAvailable('attribution.provider', facet.label)
                "
                (click)="
                  toggleQuickFilter(table, 'attribution.provider', facet)
                "
              >
                {{ facet.label }} ({{ facet.value }}),
              </a>
              <span class="text-sm text-gray-400" *ngIf="!providersKVs.length">
                No providers yet.
              </span>
            </div>

            <div class="w-full flex flex-wrap gap-1 pl-2">
              <div class="flex items-center gap-2 w-full -ml-2">
                <span class="text-sm font-bold text-gray-600">Licenses:</span>
                <hr class="grow" />
              </div>
              <a
                *ngFor="let facet of licenseKVs"
                class="text-xs cursor-pointer hover:underline"
                [class.font-bold]="
                  isQuickFilterSelected('rights.license', facet.label)
                "
                [class.text-blue-700]="
                  isQuickFilterSelected('rights.license', facet.label)
                "
                [class.underline]="
                  isQuickFilterSelected('rights.license', facet.label)
                "
                [class.text-gray-400]="
                  !isQuickFilterSelected('rights.license', facet.label) &&
                  !isQuickFilterAvailable('rights.license', facet.label)
                "
                (click)="toggleQuickFilter(table, 'rights.license', facet)"
              >
                {{ facet.label }} ({{ facet.value }}),
              </a>
              <span class="text-sm text-gray-400" *ngIf="!licenseKVs.length">
                No licenses yet.
              </span>
            </div>

            <div class="w-full flex flex-wrap gap-1 pl-2">
              <div class="flex items-center gap-2 w-full -ml-2">
                <span class="text-sm font-bold text-gray-600">Tags:</span>
                <hr class="grow" />
              </div>
              <a
                *ngFor="let facet of tagKVs"
                class="text-xs cursor-pointer hover:underline"
                [class.font-bold]="isQuickFilterSelected('tags', facet.label)"
                [class.text-blue-700]="
                  isQuickFilterSelected('tags', facet.label)
                "
                [class.underline]="isQuickFilterSelected('tags', facet.label)"
                [class.text-gray-400]="
                  !isQuickFilterSelected('tags', facet.label) &&
                  !isQuickFilterAvailable('tags', facet.label)
                "
                (click)="toggleQuickFilter(table, 'tags', facet)"
              >
                {{ facet.label }} ({{ facet.value }}),
              </a>
              <span class="text-sm text-gray-400" *ngIf="!tagKVs.length">
                No tags yet.
              </span>
            </div>
          </ng-container>
        </div>
      </div>

      <div
        *ngIf="loading"
        class="w-full border border-amber-300 bg-amber-50 text-amber-900 rounded-md p-8 shadow-sm flex items-center justify-center gap-3"
        role="status"
        aria-live="polite"
      >
        <i class="pi pi-spin pi-spinner text-xl"></i>
        <span class="text-base font-semibold">Loading catalog data...</span>
      </div>

      <div *ngIf="!loading" class="w-full">
        <p-table
          #table
          [value]="items"
          [loading]="loading"
          [globalFilterFields]="[
            'id',
            'identity.title',
            'identity.id',
            'identity.type',
            'status',
            'content.prompt',
            'attribution._authors',
            'tags',
          ]"
          class="border shadow-md"
          (onFilter)="onTableFilter(table.filteredValue || items)"
        >
          <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
            <tr>
              <td>
                <div class="flex flex-col gap-1">
                  <span class="text-xs uppercase text-gray-400">
                    {{ item.identity?.type }} |
                    {{ item.attribution._authors || "Unknown Author" }} |
                    {{ item.listed_at | date: "medium" }}
                  </span>
                  <div class="flex items-center gap-2">
                    <a
                      [routerLink]="['/catalog-v2', item.id]"
                      class="font-bold cursor-pointer text-blue-700"
                    >
                      {{ item.identity?.title || "Untitled" }}
                    </a>
                    <span
                      class="text-xs rounded-md px-1"
                      [class.bg-slate-200]="item.status == 'private'"
                      [class.bg-green-200]="item.status == 'public'"
                      [class.bg-red-200]="item.status == 'deprecated'"
                      [class.bg-yellow-200]="
                        item.status == 'broken:pending-fix'
                      "
                    >
                      {{ item.status }}
                    </span>
                    <a
                      *ngIf="item.links?.demo_url"
                      [href]="item.links.demo_url"
                      target="_blank"
                      class="text-gray-400"
                      title="View Demo"
                    >
                      <i class="fa fa-external-link"></i>
                    </a>
                  </div>
                  <span class="ml-2 text-xs">
                    ID: {{ item.identity?.id }}
                  </span>
                  <span *ngIf="item.content?.prompt" class="ml-2 text-xs">
                    Prompt: {{ item.content.prompt }}
                  </span>
                  <span *ngIf="item.tags?.length" class="ml-2 text-xs">
                    Tags: {{ item.tags.join(", ") }}
                  </span>
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td>
                <div class="text-xs text-center text-gray-400 w-full">
                  no record matched, revise your filter keyword
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</div>
